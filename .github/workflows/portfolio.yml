name: Generate Portfolio

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Mode de gÃ©nÃ©ration'
        required: false
        default: 'sp500'
        type: choice
        options:
          - sp500
          - smart_money
      top_n:
        description: 'Nombre de tickers Ã  enrichir (vide = tous)'
        required: false
        default: ''
        type: string
  schedule:
    - cron: '0 8 * * 1'  # Lundi 8h UTC

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 60 min pour 500 tickers
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Generate portfolio
        env:
          API_TWELVEDATA: ${{ secrets.API_TWELVEDATA }}
          API_OPENAI: ${{ secrets.API_OPENAI }}
          ENRICHMENT_MODE: ${{ inputs.mode || 'sp500' }}
        run: |
          MODE="${{ inputs.mode || 'sp500' }}"
          TOP_N="${{ inputs.top_n }}"
          
          if [ -n "$TOP_N" ]; then
            echo "ðŸš€ Lancement mode $MODE avec top-n=$TOP_N"
            python main.py --mode "$MODE" --top-n "$TOP_N"
          else
            echo "ðŸš€ Lancement mode $MODE (tous les tickers)"
            python main.py --mode "$MODE"
          fi
      
      - name: Commit outputs
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add outputs/
          git commit -m "ðŸ“Š Portfolio $(date +%Y-%m-%d) [mode: ${{ inputs.mode || 'sp500' }}]" || echo "No changes to commit"
          git push
