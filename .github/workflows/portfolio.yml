name: Generate Portfolio

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Mode de gÃ©nÃ©ration'
        required: false
        default: 'sp500'
        type: choice
        options:
          - sp500
          - smart_money
      top_n:
        description: 'Nombre de tickers Ã  enrichir (vide = tous)'
        required: false
        default: ''
        type: string
  schedule:
    - cron: '0 8 * * 1'  # Lundi 8h UTC

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2h pour 500 tickers (config conservative)
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Generate portfolio
        env:
          API_TWELVEDATA: ${{ secrets.API_TWELVEDATA }}
          API_OPENAI: ${{ secrets.API_OPENAI }}
          ENRICHMENT_MODE: ${{ inputs.mode || 'sp500' }}
        run: |
          MODE="${{ inputs.mode || 'sp500' }}"
          TOP_N="${{ inputs.top_n }}"
          
          if [ -n "$TOP_N" ]; then
            echo "ğŸš€ Lancement mode $MODE avec top-n=$TOP_N"
            python main.py --mode "$MODE" --top-n "$TOP_N"
          else
            echo "ğŸš€ Lancement mode $MODE (tous les tickers)"
            python main.py --mode "$MODE"
          fi
      
      - name: Update latest symlink
        run: |
          cd outputs
          # Trouver le dossier le plus rÃ©cent (format YYYY-MM-DD)
          LATEST_DIR=$(ls -d 20??-??-?? 2>/dev/null | sort -r | head -1)
          
          if [ -n "$LATEST_DIR" ]; then
            echo "ğŸ“ Latest directory: $LATEST_DIR"
            # Supprimer l'ancien latest (dossier ou lien)
            rm -rf latest
            # Copier le contenu du dernier dossier dans latest
            cp -r "$LATEST_DIR" latest
            echo "âœ… Latest updated to $LATEST_DIR"
          else
            echo "âš ï¸ No dated directory found"
          fi
      
      - name: Commit outputs
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add outputs/
          git commit -m "ğŸ“Š Portfolio $(date +%Y-%m-%d) [mode: ${{ inputs.mode || 'sp500' }}]" || echo "No changes to commit"
          git push
