name: HedgeFollow Daily Pipeline

on:
  schedule:
    # Runs at 06:00 UTC every day
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Scraping mode'
        required: false
        default: 'full'
        type: choice
        options:
          - test
          - quick
          - full
      funds_count:
        description: 'Number of funds to scrape'
        required: false
        default: '20'
      top_count:
        description: 'Number of top performers to keep'
        required: false
        default: '10'
      holdings_count:
        description: 'Number of holdings per fund'
        required: false
        default: '20'

jobs:
  scrape-hedgefollow:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create .env file
      run: |
        echo "REQUESTS_SLEEP_SECONDS=3" >> .env
        echo "HEDGEFOLLOW_TOP_N_FUNDS=${{ github.event.inputs.funds_count || '20' }}" >> .env
        echo "LOG_LEVEL=INFO" >> .env
    
    - name: Run HedgeFollow Pipeline
      env:
        PYTHONPATH: .
      run: |
        # Determine mode
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MODE="${{ github.event.inputs.mode }}"
        else
          MODE="full"
        fi
        
        echo "üöÄ Running HedgeFollow Pipeline in $MODE mode"
        echo "======================================"
        
        # Run the pipeline
        python run_hedgefollow.py --mode $MODE --verbose
        
        # Show results summary
        echo ""
        echo "üìä Results Summary:"
        if [ -f "data/raw/hedgefollow/funds_top10_filtered.csv" ]; then
          echo "Top Funds:"
          python -c "
import pandas as pd
df = pd.read_csv('data/raw/hedgefollow/funds_top10_filtered.csv')
print(df[['fund_name', 'perf_3y_annualized', 'aum_billions']].head(5).to_string(index=False))
"
        fi
    
    - name: Generate Report
      if: success()
      run: |
        python -c "
import pandas as pd
from datetime import datetime
import json

# Load data
funds_file = 'data/raw/hedgefollow/funds_top10_filtered.csv'
holdings_files = list(Path('data/raw/hedgefollow').glob('holdings_*.csv'))

if Path(funds_file).exists():
    funds = pd.read_csv(funds_file)
    
    report = {
        'timestamp': datetime.now().isoformat(),
        'funds_count': len(funds),
        'avg_performance': funds['perf_3y_annualized'].mean(),
        'total_aum_billions': funds['aum_billions'].sum(),
        'top_fund': {
            'name': funds.iloc[0]['fund_name'],
            'performance': funds.iloc[0]['perf_3y_annualized']
        }
    }
    
    if holdings_files:
        holdings = pd.read_csv(sorted(holdings_files)[-1])
        report['holdings_count'] = len(holdings)
        report['unique_tickers'] = holdings['ticker'].nunique()
        
        # Top holdings
        top_holdings = holdings['ticker'].value_counts().head(5)
        report['top_holdings'] = top_holdings.to_dict()
    
    # Save report
    with open('data/scraping_report.json', 'w') as f:
        json.dump(report, f, indent=2)
    
    print('üìä Report generated successfully!')
    print(json.dumps(report, indent=2))
"
        from pathlib import Path
    
    - name: Commit and Push Data
      if: success()
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        # Add data files
        git add data/raw/hedgefollow/*.csv || true
        git add data/scraping_report.json || true
        
        # Check if there are changes
        if git diff --cached --quiet; then
          echo "No new data to commit"
        else
          # Create commit message with summary
          COMMIT_MSG="ü§ñ Update HedgeFollow data $(date +'%Y-%m-%d %H:%M')"
          
          if [ -f "data/scraping_report.json" ]; then
            FUNDS_COUNT=$(python -c "import json; print(json.load(open('data/scraping_report.json'))['funds_count'])" 2>/dev/null || echo "N/A")
            COMMIT_MSG="$COMMIT_MSG - $FUNDS_COUNT funds scraped"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
        fi
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: hedgefollow-data-${{ github.run_number }}
        path: |
          data/raw/hedgefollow/*.csv
          data/scraping_report.json
          logs/*.log
        retention-days: 30
    
    - name: Notify on Failure
      if: failure()
      run: |
        echo "‚ùå HedgeFollow scraping failed!"
        echo "Check the logs for details."
        # Add Discord/Slack notification here if webhook configured
