name: SmartMoney Scraper Optimized

on:
  workflow_dispatch:
    inputs:
      use_test_data:
        description: 'Use test data instead of real scraping'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      hf_top_funds:
        description: 'Number of top HedgeFollow funds to scrape'
        required: false
        default: '10'
        type: string
      hf_top_positions:
        description: 'Number of top positions per fund'
        required: false
        default: '30'
        type: string
  
  # Daily for insiders/screener
  schedule:
    - cron: '0 14 * * *'
  
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/**'

env:
  # Global settings
  RUN_ID: ${{ github.run_id }}-${{ github.run_attempt }}
  PYTHON_VERSION: '3.11'
  # HedgeFollow limits
  HF_TOP_FUNDS: ${{ github.event.inputs.hf_top_funds || '10' }}
  HF_TOP_POSITIONS: ${{ github.event.inputs.hf_top_positions || '30' }}
  # Dataroma limits  
  DTR_TOP_MANAGERS: '10'

jobs:
  # ========== SETUP ==========
  setup:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.set-run-id.outputs.run_id }}
      timestamp: ${{ steps.set-run-id.outputs.timestamp }}
    
    steps:
    - name: Set Run ID and Timestamp
      id: set-run-id
      run: |
        TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
        echo "run_id=${{ env.RUN_ID }}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        echo "ðŸ“… Run ID: ${{ env.RUN_ID }}"
        echo "â° Timestamp: ${TIMESTAMP}"

  # ========== HEDGEFOLLOW ==========
  hedgefollow:
    runs-on: ubuntu-latest
    needs: setup
    env:
      RUN_ID: ${{ needs.setup.outputs.run_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create directories
      run: |
        mkdir -p data/raw/hedgefollow
        mkdir -p data/logs
    
    - name: Configure environment
      run: |
        cp .env.example .env
        echo "RUN_ID=${{ env.RUN_ID }}" >> .env
        echo "HF_TOP_FUNDS=${{ env.HF_TOP_FUNDS }}" >> .env
        echo "HF_TOP_POSITIONS=${{ env.HF_TOP_POSITIONS }}" >> .env
    
    - name: Scrape HedgeFollow Funds
      id: hf-funds
      run: |
        set -e
        echo "ðŸŽ¯ Scraping top ${{ env.HF_TOP_FUNDS }} HedgeFollow funds..."
        python -m src.hedgefollow.funds
    
    - name: Scrape HedgeFollow Holdings
      id: hf-holdings
      if: success()
      run: |
        set -e
        echo "ðŸ“Š Scraping holdings (max ${{ env.HF_TOP_POSITIONS }} per fund)..."
        python -m src.hedgefollow.holdings
    
    - name: Scrape HedgeFollow Insiders
      id: hf-insiders
      run: |
        echo "ðŸ‘¤ Scraping insider trades..."
        python -m src.hedgefollow.insiders || echo "::warning::Insider scraper failed"
    
    - name: Run HedgeFollow Screener
      id: hf-screener
      run: |
        echo "ðŸ” Running screener..."
        python -m src.hedgefollow.screener || echo "::warning::Screener failed"
    
    - name: Upload HedgeFollow data
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: hedgefollow-data-${{ env.RUN_ID }}
        path: data/raw/hedgefollow/
        retention-days: 30
        if-no-files-found: warn
    
    - name: HedgeFollow Summary
      if: always()
      run: |
        {
          echo "### ðŸŽ¯ HedgeFollow Results"
          echo ""
          echo "**Settings:**"
          echo "- Top Funds: ${{ env.HF_TOP_FUNDS }}"
          echo "- Top Positions: ${{ env.HF_TOP_POSITIONS }}"
          echo ""
          echo "**Files created:**"
          echo '```'
          ls -lh data/raw/hedgefollow/ 2>/dev/null || echo "No files created"
          echo '```'
          echo ""
          
          # Show sample data if exists
          if [ -f "data/raw/hedgefollow/funds_${{ env.RUN_ID }}.csv" ]; then
            echo "**Sample funds data:**"
            echo '```csv'
            head -5 "data/raw/hedgefollow/funds_${{ env.RUN_ID }}.csv"
            echo '```'
          fi
        } >> $GITHUB_STEP_SUMMARY

  # ========== DATAROMA ==========
  dataroma:
    runs-on: ubuntu-latest
    needs: setup
    env:
      RUN_ID: ${{ needs.setup.outputs.run_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create directories
      run: |
        mkdir -p data/raw/dataroma
        mkdir -p data/logs
    
    - name: Configure environment
      run: |
        cp .env.example .env
        echo "RUN_ID=${{ env.RUN_ID }}" >> .env
        echo "DTR_TOP_MANAGERS=${{ env.DTR_TOP_MANAGERS }}" >> .env
    
    - name: Scrape Dataroma Managers
      id: dtr-managers
      run: |
        set -e
        echo "ðŸ‘” Scraping Dataroma superinvestors..."
        python -m src.dataroma.managers
    
    - name: Scrape Dataroma Holdings
      id: dtr-holdings
      if: success()
      run: |
        set -e
        echo "ðŸ“ˆ Scraping superinvestor holdings..."
        python -m src.dataroma.holdings
    
    - name: Scrape Grand Portfolio
      id: dtr-grand
      run: |
        echo "ðŸ† Scraping Grand Portfolio..."
        python -m src.dataroma.grand_portfolio || echo "::warning::Grand Portfolio failed"
    
    - name: Scrape Dataroma Insiders
      id: dtr-insiders
      run: |
        echo "ðŸ”” Scraping real-time insiders..."
        python -m src.dataroma.realtime_insider || echo "::warning::RT Insider failed"
    
    - name: Upload Dataroma data
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dataroma-data-${{ env.RUN_ID }}
        path: data/raw/dataroma/
        retention-days: 30
        if-no-files-found: warn
    
    - name: Dataroma Summary
      if: always()
      run: |
        {
          echo "### ðŸ›ï¸ Dataroma Results"
          echo ""
          echo "**Settings:**"
          echo "- Top Managers: ${{ env.DTR_TOP_MANAGERS }}"
          echo ""
          echo "**Files created:**"
          echo '```'
          ls -lh data/raw/dataroma/ 2>/dev/null || echo "No files created"
          echo '```'
        } >> $GITHUB_STEP_SUMMARY

  # ========== BUILD UNIVERSE ==========
  build-universe:
    runs-on: ubuntu-latest
    needs: [setup, hedgefollow, dataroma]
    if: always() && (needs.hedgefollow.result == 'success' || needs.dataroma.result == 'success')
    env:
      RUN_ID: ${{ needs.setup.outputs.run_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create directories
      run: |
        mkdir -p data/raw/hedgefollow
        mkdir -p data/raw/dataroma
        mkdir -p data/processed
    
    - name: Download HedgeFollow data
      uses: actions/download-artifact@v4
      with:
        name: hedgefollow-data-${{ env.RUN_ID }}
        path: data/raw/hedgefollow/
      continue-on-error: true
    
    - name: Download Dataroma data
      uses: actions/download-artifact@v4
      with:
        name: dataroma-data-${{ env.RUN_ID }}
        path: data/raw/dataroma/
      continue-on-error: true
    
    - name: Build Universe
      run: |
        echo "ðŸŒ Building SmartMoney Universe..."
        export RUN_ID="${{ env.RUN_ID }}"
        python -m src.pipelines.build_universe
    
    - name: Upload Universe
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: universe-${{ env.RUN_ID }}
        path: data/processed/
        retention-days: 90
    
    - name: Universe Summary
      if: always()
      run: |
        {
          echo "### ðŸŒŸ SmartMoney Universe"
          echo ""
          
          UNIVERSE_FILE="data/processed/universe_smartmoney_${{ env.RUN_ID }}.csv"
          
          if [ -f "$UNIVERSE_FILE" ]; then
            TOTAL_TICKERS=$(tail -n +2 "$UNIVERSE_FILE" | wc -l)
            echo "**Statistics:**"
            echo "- Total tickers: ${TOTAL_TICKERS}"
            echo ""
            echo "**Top 10 SmartMoney Stocks:**"
            echo '```csv'
            head -11 "$UNIVERSE_FILE" | cut -d',' -f1-5
            echo '```'
          else
            echo "âŒ No universe file generated"
          fi
        } >> $GITHUB_STEP_SUMMARY

  # ========== FINAL REPORT ==========
  report:
    runs-on: ubuntu-latest
    needs: [hedgefollow, dataroma, build-universe]
    if: always()
    
    steps:
    - name: Final Report
      run: |
        {
          echo "## ðŸ“Š SmartMoney Scraper Report"
          echo ""
          echo "### Job Status:"
          echo "- HedgeFollow: ${{ needs.hedgefollow.result }} $([[ '${{ needs.hedgefollow.result }}' == 'success' ]] && echo 'âœ…' || echo 'âŒ')"
          echo "- Dataroma: ${{ needs.dataroma.result }} $([[ '${{ needs.dataroma.result }}' == 'success' ]] && echo 'âœ…' || echo 'âŒ')"
          echo "- Universe: ${{ needs.build-universe.result }} $([[ '${{ needs.build-universe.result }}' == 'success' ]] && echo 'âœ…' || echo 'âŒ')"
          echo ""
          echo "### Configuration:"
          echo "- Run ID: \`${{ env.RUN_ID }}\`"
          echo "- HF Top Funds: ${{ env.HF_TOP_FUNDS }}"
          echo "- HF Top Positions: ${{ env.HF_TOP_POSITIONS }}"
          echo "- DTR Top Managers: ${{ env.DTR_TOP_MANAGERS }}"
          echo ""
          echo "---"
          echo "_Generated at $(date -u +'%Y-%m-%d %H:%M:%S UTC')_"
        } >> $GITHUB_STEP_SUMMARY
